# [Epic] 最初のアクションリストを個人に向けてカスタマイズする

## Overview

現在、チャット画面で初回表示される「質問してみましょう」のアクションリスト(サジェスト)は、全ユーザーに対して同じ固定の 3 つの項目がハードコードされています。この機能を拡張し、ユーザーの行動履歴や興味に基づいてパーソナライズされたアクションリストを提供することで、ユーザーエンゲージメントを向上させます。

### Background and Purpose

**課題:**

- 現在のアクションリスト(`_ChatSuggestions`)は[home_screen.dart:444-457](client/lib/ui/feature/home/home_screen.dart#L444-L457)にハードコードされている
- すべてのユーザーに同じ 3 つの提案が表示されるため、個々のユーザーの興味や利用シーンにマッチしない
- ユーザーが過去に興味を示したトピックや、よく使う相談パターンが反映されていない

**目的:**

- ユーザーの過去のチャット履歴や選択傾向を分析し、パーソナライズされたアクションリストを提供
- エンゲージメント率の向上とユーザー満足度の改善
- 新規ユーザーには適切なデフォルトアクション、既存ユーザーには学習結果を反映

### Expected Impact

- 初回表示アクションリストのクリック率(CTR)の向上: 20%以上の改善を目標
- ユーザーのチャット継続率の向上
- ユーザーごとにカスタマイズされた体験の提供によるリテンション率の改善

### Feature Description

ユーザーごとにパーソナライズされた初回アクションリストを生成・表示する機能を実装します。

**主な機能:**

1. **ユーザーごとのパーソナライゼーション**

   - ユーザーの過去のチャット履歴から興味のあるトピックを推定
   - 選択されたアクションの履歴を記録
   - 時間帯や曜日などのコンテキスト情報を考慮

2. **表示ロジック**

   - 新規ユーザー: デフォルトの人気アクションを表示
   - 既存ユーザー: パーソナライズされたアクションを表示
   - 定期的にアクションをローテーションして新鮮さを保つ

## User Stories

- As a **新規ユーザー**, I want **初めてアプリを開いた時に魅力的なアクション候補を見る** so that **何を質問すれば良いかすぐにわかる**
- As a **既存ユーザー**, I want **自分の興味に合ったアクション候補が表示される** so that **スムーズに会話を始められる**
- As a **頻繁に音楽について相談するユーザー**, I want **音楽関連のアクション候補が優先的に表示される** so that **毎回同じような質問を入力する手間が省ける**

## Implement Issue List

### 1. ユーザーの会話履歴をローカルに保存する

- [ ] 会話履歴データモデルの設計 (`ChatHistoryRecord` model)
- [ ] 会話履歴をローカルストレージに保存する Repository の実装 (`ChatHistoryRepository`)
- [ ] チャットメッセージ送信時に会話履歴を記録する処理の追加
- [ ] 会話履歴のタイムスタンプ管理機能の実装

### 2. ユーザーの会話履歴を最大 30 日間保存し、定期的に削除する処理を追加

- [ ] 会話履歴の保存期限（30 日）の定数定義
- [ ] 古い会話履歴を削除する Service の実装 (`ChatHistoryCleanupService`)
- [ ] アプリ起動時に古い会話履歴を削除する処理の実装
- [ ] バックグラウンドでの定期削除処理の実装（例: 日次）

### 3. 定期的にアプリ起動中にバックグラウンドで、ユーザーの会話履歴からファーストアクションのリストを更新する機能を追加

- [ ] 会話履歴からファーストアクション候補を生成する Service の実装 (`FirstActionGeneratorService`)
- [ ] 会話履歴の分析ロジックの実装（頻出トピック、キーワード抽出）
- [ ] 生成されたファーストアクションをローカルストレージに保存する Repository の実装 (`GeneratedFirstActionsRepository`)
- [ ] バックグラウンドでファーストアクションを更新する処理の実装
- [ ] アプリ起動時または定期的に更新処理を実行するトリガーの実装

### 4. 蓄積されたファーストアクションのリストからファーストアクションを表示する

- [ ] 生成されたファーストアクションを取得する Provider の実装 (`generatedFirstActionsProvider`)
- [ ] `_ChatSuggestions` Widget を動的取得に改修（ハードコードから生成済みアクション取得へ）
- [ ] ファーストアクションが未生成の場合のフォールバック処理（デフォルトアクション表示）
- [ ] ファーストアクションの表示ロジックの実装（優先度、ローテーション）

### Testing & QA

- [ ] 会話履歴の保存・取得の単体テスト
- [ ] 30 日以上経過した会話履歴の削除テスト
- [ ] ファーストアクション生成ロジックの単体テスト
- [ ] バックグラウンド更新処理の動作確認テスト
- [ ] `_ChatSuggestions` Widget の Widget テスト（動的アクション表示）
- [ ] 新規ユーザーでの E2E テスト（デフォルトアクション表示確認）
- [ ] 既存ユーザーでの E2E テスト（生成されたアクション表示確認）
- [ ] 会話履歴が増えた際のファーストアクション更新確認

### Documentation

- [ ] 会話履歴のローカルストレージスキーマドキュメント作成
- [ ] ファーストアクション生成アルゴリズムの設計ドキュメント作成
- [ ] バックグラウンド処理のフローチャート作成
